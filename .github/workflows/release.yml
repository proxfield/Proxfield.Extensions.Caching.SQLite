name: Nuget

on:
    release:
        types: [published]

jobs:
 publish:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # only run job if on the main branch 

    steps:
        - uses: actions/checkout@v2
        - name: Setup .Net Core
          uses: actions/setup-dotnet@v1
          with:
            dotnet-version: 6.0.x
        - name: Restoring Package
          run: dotnet restore 
        - name: Building 
          run: dotnet build --configuration Release
        - name: Create Nuget Package
          run: dotnet pack -c Release /p:Version=${{ github.event.release.tag_name }} /p:PackageReleaseNotes="See https://github.com/proxfield/Proxfield.Extensions.Caching.SQLite/releases/tag/${{ github.event.release.tag_name }}"
          working-directory: ./Proxfield.Extensions.Caching.SQLite
        - name: Archive Nuget Package
          uses: actions/upload-artifact@v1
          with:
            name: Proxfield.Extensions.Caching.SQLite
            path: ./src/Proxfield.Extensions.Caching.SQLite.DependencyInjection/bin/Release/Proxfield.Extensions.Caching.SQLite.${{ github.event.release.tag_name }}.nupkg 
        - name: Publish Nuget Package
          run: dotnet nuget push **/*.nupkg --api-key ${{ secrets.nuget_api_key }} --source https://api.nuget.org/v3/index.json --no-symbols true